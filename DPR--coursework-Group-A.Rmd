---
title: "DS202.3 - Treatment Response Prediction"
author: "Member 1 RKG Tharishika (ID), KADP Kumarapeli (36431)"
date: "2025-02-13"
output: html_document
---
# Problem Statement

#Import Libraries and Environment Setup 
```{r}
library(tidyverse)
library(gridExtra)
library(corrplot)
library(ggpubr)
library(knitr)
```

```{r}
library(lubridate)
library(scales)
```

#Loading Dataset
```{r}
raw_data <-read_tsv("msk_chord_2024_clinical_data.tsv")
```

```{r}
dim(raw_data)
```

```{r}
glimpse(raw_data)
```

# Problem definition
Can demographic variables and basic clinical features explain variation in treatment response patterns?

This notebook explores whether routinely collected demographic and clinical variables are associated with patterns of treatment response.

Because direct response measurements are unavailable, a composite *response proxy* is constructed using overall survival time, disease extent inferred from clinical notes, and recorded metastatic status.

The key variables considered include:
- Age
- Sex
- Cancer type
- Stage

# Data cleaning and selection

Raw clinical data are imported from a tab-separated file and restricted to patients with valid staging, clinical summaries, and survival outcomes.

Key demographic and disease variables are renamed for clarity, while additional features—such as binary stage grouping, inferred disease extent, age categories, and metastatic indicators—are engineered to support downstream analysis.

```{r}
data_clean <- raw_data %>%
  select(
    age = `Current Age`,
    sex = Sex,
    cancer_type = `Cancer Type`,
    stage = `Stage (Highest Recorded)`,
    clinical_summary = `Clinical Summary`,
    survival_months = `Overall Survival (Months)`,
    survival_status = `Overall Survival Status`,
    metastatic_site = `Metastatic Site`,
    sample_type = `Sample Type`,
    primary_site = `Primary Tumor Site`
  ) %>%
  filter(
    stage %in% c("Stage 1-3", "Stage 4"),
    !is.na(clinical_summary),
    !is.na(survival_months)
  ) %>%
  mutate(

    ## Binary stage
    stage_binary = ifelse(
      stage == "Stage 4",
      "Advanced",
      "Early"
    ),

    ## Disease extent inferred from notes
    disease_extent = case_when(
      str_detect(clinical_summary, "Distant|Metasta") ~ "Distant",
      str_detect(clinical_summary, "Regional") ~ "Regional",
      str_detect(clinical_summary, "Localized|In Situ") ~ "Localized",
      TRUE ~ "Other"
    ),

    ## Metastasis indicator
    has_metastasis = !is.na(metastatic_site) &
                     metastatic_site != "",

    ## Age groups
    age_group = cut(
      age,
      breaks = c(0, 50, 65, 100),
      labels = c("Under 50", "50–65", "Over 65"),
      include.lowest = TRUE
    ),

    ## Event indicator
    died = str_detect(survival_status, "DECEASED"),

    ## Simplified cancer categories
    cancer_simple = ifelse(
      cancer_type %in% c(
        "Breast Cancer",
        "Non-Small Cell Lung Cancer",
        "Colorectal Cancer",
        "Prostate Cancer",
        "Pancreatic Cancer"
      ),
      cancer_type,
      "Other"
    )
  )

cat("Final N:", nrow(data_clean))
```

#Summarized Missing Data
```{r}
raw_data %>%
  summarise(across(everything(),
                   ~mean(is.na(.))*100)) %>%
  pivot_longer(everything(),
               names_to = "variable",
               values_to = "pct_missing") %>%
  arrange(desc(pct_missing))

```

```{r}
cat("Initial N:", nrow(raw_data), "\n")
cat("After filtering:", nrow(data_clean), "\n")

```

The original dataset contains missing values, inconsistent variables, and unstructured clinical information that may reduce the accuracy of survival analysis.

Therefore, the data must be cleaned by selecting relevant variables, removing records with critical missing information, and transforming features into meaningful categories such as disease stage, age group, and metastasis status.

This process ensures a reliable and structured dataset for analyzing cancer survival outcomes.

# Construction of Response Proxy

A composite response index is defined using:

* Survival quartiles
* Disease extent
* Metastatic presence

Because formal treatment response labels are not available, a quantitative proxy index is created.

Survival duration is discretized into quartiles, disease extent is converted into ordinal scores, and metastatic presence is incorporated as a binary factor. These components are combined into a weighted index scaled from 0 to 100 and further categorized into four qualitative response groups.

```{r}
qs <- quantile(
  data_clean$survival_months,
  probs = c(.25, .5, .75),
  na.rm = TRUE
)

data_clean <- data_clean %>%
  mutate(

    survival_score = case_when(
      survival_months >= qs[3] ~ 3,
      survival_months >= qs[2] ~ 2,
      survival_months >= qs[1] ~ 1,
      TRUE ~ 0
    ),

    disease_score = recode(
      disease_extent,
      "Localized" = 2,
      "Regional"  = 1,
      "Distant"   = 0,
      .default = 0
    ),

    mets_score = ifelse(has_metastasis, 0, 1),

    response_index =
      (survival_score * 3 +
       disease_score  * 2 +
       mets_score) / 14 * 100,

    response_category = cut(
      response_index,
      breaks = c(-1, 25, 50, 75, 100),
      labels = c("Poor", "Fair", "Good", "Excellent")
    )
  )

```

# 5. Descriptive Statistics

Summary statistics are calculated to characterize the cohort in terms of age, survival time, stage distribution, metastatic burden, and overall response scores.

```{r}
data_clean %>%
  summarise(
    n = n(),
    mean_age = mean(age),
    median_survival = median(survival_months),
    pct_stage4 = mean(stage_binary == "Advanced"),
    pct_mets = mean(has_metastasis),
    mean_response = mean(response_index)
  )

```
## 5.1 By cancer type

```{r}
data_clean %>%
  group_by(cancer_simple) %>%
  summarise(
    n = n(),
    median_survival = median(survival_months),
    pct_stage4 = mean(stage_binary == "Advanced"),
    mean_response = mean(response_index)
  ) %>%
  arrange(desc(mean_response))

```

## 5.2 Extended Descriptive Analysis

The extended descriptive analysis provides a clear overview of the patient cohort by summarizing age, survival time, disease severity, and treatment response.

Measures such as median, standard desiation, and interquartile range help understand both typical values and variability within the dataset.

```{r}
extended_stats <- data_clean %>%
  summarise(
    total_patients = n(),
    
    # Age statistics
    mean_age = mean(age, na.rm = TRUE),
    sd_age = sd(age, na.rm = TRUE),
    min_age = min(age, na.rm = TRUE),
    q1_age = quantile(age, 0.25, na.rm = TRUE),
    median_age = median(age, na.rm = TRUE),
    q3_age = quantile(age, 0.75, na.rm = TRUE),
    max_age = max(age, na.rm = TRUE),
    
    # Survival statistics
    mean_survival = mean(survival_months, na.rm = TRUE),
    median_survival = median(survival_months, na.rm = TRUE),
    iqr_survival = IQR(survival_months, na.rm = TRUE),
    
    # Disease severity
    pct_advanced_stage = mean(stage_binary == "Advanced", na.rm = TRUE) * 100,
    pct_metastasis = mean(has_metastasis, na.rm = TRUE) * 100,
    
    # Treatment response
    mean_response = mean(response_index, na.rm = TRUE),
    sd_response = sd(response_index, na.rm = TRUE)
  )

extended_stats
```

## 5.4 Deeper Analysis by Cancer Type

The analysis by cancer type highlights differences in survival, stage distribution, and treatment response across groups.

Some cancers show better outcomes and higher response rates, while others appear more aggressive with lower survival.

```{r}
extended_stats <- data_clean %>%
  summarise(
    total_patients = n(),
    
    # Age statistics
    mean_age = mean(age, na.rm = TRUE),
    sd_age = sd(age, na.rm = TRUE),
    min_age = min(age, na.rm = TRUE),
    q1_age = quantile(age, 0.25, na.rm = TRUE),
    median_age = median(age, na.rm = TRUE),
    q3_age = quantile(age, 0.75, na.rm = TRUE),
    max_age = max(age, na.rm = TRUE),
    
    # Survival statistics
    mean_survival = mean(survival_months, na.rm = TRUE),
    median_survival = median(survival_months, na.rm = TRUE),
    iqr_survival = IQR(survival_months, na.rm = TRUE),
    
    # Disease severity
    pct_advanced_stage = mean(stage_binary == "Advanced", na.rm = TRUE) * 100,
    pct_metastasis = mean(has_metastasis, na.rm = TRUE) * 100,
    
    # Treatment response
    mean_response = mean(response_index, na.rm = TRUE),
    sd_response = sd(response_index, na.rm = TRUE)
  )

extended_stats
```
# Exploratory Data Analysis (EDA)

## Distribution of Key Variables

### Age Distribution
```{r fig.width=10, fig.height=4}
p1 <- ggplot(data_clean, aes(x = age)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "white") +
  labs(title = "Distribution of Age", x = "Age (years)", y = "Count") +
  theme_minimal()

p2 <- ggplot(data_clean, aes(x = age_group, fill = age_group)) +
  geom_bar() +
  labs(title = "Age Groups", x = "Age Group", y = "Count") +
  theme_minimal() +
  theme(legend.position = "none")

grid.arrange(p1, p2, ncol = 2)
```

### Survival Distribution
```{r fig.width=10, fig.height=4}
p3 <- ggplot(data_clean, aes(x = survival_months)) +
  geom_histogram(bins = 40, fill = "darkgreen", color = "white") +
  labs(title = "Distribution of Survival Time", 
       x = "Survival (months)", y = "Count") +
  theme_minimal()

p4 <- ggplot(data_clean, aes(x = survival_months)) +
  geom_density(fill = "darkgreen", alpha = 0.5) +
  geom_vline(xintercept = median(data_clean$survival_months), 
             linetype = "dashed", color = "red") +
  labs(title = "Survival Density Plot", 
       x = "Survival (months)", y = "Density") +
  theme_minimal()

grid.arrange(p3, p4, ncol = 2)
```

### Response Index Distribution
```{r fig.width=10, fig.height=4}
p5 <- ggplot(data_clean, aes(x = response_index)) +
  geom_histogram(bins = 30, fill = "coral", color = "white") +
  labs(title = "Distribution of Response Index", 
       x = "Response Index (0-100)", y = "Count") +
  theme_minimal()

p6 <- ggplot(data_clean, aes(x = response_category, fill = response_category)) +
  geom_bar() +
  labs(title = "Response Categories", 
       x = "Response Category", y = "Count") +
  scale_fill_brewer(palette = "RdYlGn") +
  theme_minimal() +
  theme(legend.position = "none")

grid.arrange(p5, p6, ncol = 2)
```


 
